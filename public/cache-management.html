<!-- public/cache-management.html -->
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Cache - OCR, Dịch và PDF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #0d6efd;
            margin-bottom: 30px;
            text-align: center;
        }

        .stats-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 600;
            color: #495057;
        }

        .stat-value {
            font-weight: 500;
            color: #0d6efd;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .alert {
            display: none;
            margin-top: 20px;
        }

        .cache-performance {
            margin-top: 30px;
            padding: 20px;
            background-color: #e9f7ef;
            border-radius: 10px;
        }

        .performance-title {
            color: #27ae60;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .performance-stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .refresh-icon {
            cursor: pointer;
            color: #0d6efd;
            font-size: 1.2rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Quản lý Cache</h1>

        <div class="text-end mb-4">
            <a href="index.html" class="btn btn-primary">
                <i class="bi bi-arrow-left"></i> Quay lại Trang chính
            </a>
        </div>

        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Thống kê Cache</h4>
                <span class="refresh-icon" id="refreshStats" title="Làm mới thống kê">
                    <i class="bi bi-arrow-clockwise"></i> Làm mới
                </span>
            </div>

            <div class="stat-item">
                <span class="stat-label">Tổng số cache:</span>
                <span class="stat-value" id="totalCacheItems">Đang tải...</span>
            </div>

            <div class="stat-item">
                <span class="stat-label">Kích thước cache:</span>
                <span class="stat-value" id="cacheSize">Đang tải...</span>
            </div>

            <div class="stat-item">
                <span class="stat-label">Cache cũ nhất:</span>
                <span class="stat-value" id="oldestCache">Đang tải...</span>
            </div>

            <div class="stat-item">
                <span class="stat-label">Cache mới nhất:</span>
                <span class="stat-value" id="newestCache">Đang tải...</span>
            </div>
        </div>

        <div class="cache-performance">
            <h4 class="performance-title">Hiệu suất Cache</h4>
            <p>Cache giúp tăng tốc độ xử lý bằng cách lưu trữ kết quả của các yêu cầu trước đó. Khi một yêu cầu mới đến,
                hệ thống sẽ kiểm tra xem kết quả đã được lưu trong cache chưa trước khi thực hiện các xử lý tốn kém.</p>

            <div class="performance-stat">
                <span>Thời gian xử lý trung bình không có cache:</span>
                <span>5-10 giây/yêu cầu</span>
            </div>

            <div class="performance-stat">
                <span>Thời gian xử lý trung bình có cache:</span>
                <span>&lt; 0.5 giây/yêu cầu</span>
            </div>

            <div class="performance-stat">
                <span>Tiết kiệm tài nguyên CPU:</span>
                <span>~90%</span>
            </div>
        </div>

        <div class="text-center mt-4">
            <button class="btn btn-danger btn-lg" id="clearCacheBtn">
                <i class="bi bi-trash"></i> Xóa tất cả Cache
            </button>
        </div>

        <div class="loading" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang xử lý...</span>
            </div>
            <p class="mt-2">Đang xử lý, vui lòng đợi...</p>
        </div>

        <div class="alert alert-success" id="successAlert" role="alert">
            Thao tác thành công!
        </div>

        <div class="alert alert-danger" id="errorAlert" role="alert">
            Đã xảy ra lỗi. Vui lòng thử lại.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const refreshStatsBtn = document.getElementById('refreshStats');
            const clearCacheBtn = document.getElementById('clearCacheBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const successAlert = document.getElementById('successAlert');
            const errorAlert = document.getElementById('errorAlert');

            // Các phần tử hiển thị thống kê
            const totalCacheItems = document.getElementById('totalCacheItems');
            const cacheSize = document.getElementById('cacheSize');
            const oldestCache = document.getElementById('oldestCache');
            const newestCache = document.getElementById('newestCache');

            // Hàm hiển thị thông báo
            function showAlert(element, message, duration = 3000) {
                element.textContent = message;
                element.style.display = 'block';

                setTimeout(() => {
                    element.style.display = 'none';
                }, duration);
            }

            // Hàm lấy thống kê cache
            async function fetchCacheStats() {
                try {
                    const response = await fetch('/cache-stats');

                    if (!response.ok) {
                        throw new Error('Không thể lấy thống kê cache');
                    }

                    const data = await response.json();

                    // Cập nhật UI
                    totalCacheItems.textContent = data.totalCacheItems; // Fixed the property name
                    cacheSize.textContent = data.cacheSize;

                    // Định dạng thời gian
                    if (data.oldestCache) {
                        const oldestDate = new Date(data.oldestCache);
                        oldestCache.textContent = oldestDate.toLocaleString();
                    } else {
                        oldestCache.textContent = 'Không có';
                    }

                    if (data.newestCache) {
                        const newestDate = new Date(data.newestCache);
                        newestCache.textContent = newestDate.toLocaleString();
                    } else {
                        newestCache.textContent = 'Không có';
                    }
                } catch (error) {
                    console.error('Error fetching cache stats:', error);
                    showAlert(errorAlert, 'Không thể lấy thống kê cache: ' + error.message);
                }
            }

            // Hàm xóa tất cả cache
            async function clearAllCache() {
                try {
                    loadingSpinner.style.display = 'block';

                    const response = await fetch('/clear-cache', {
                        method: 'POST'
                    });

                    if (!response.ok) {
                        throw new Error('Không thể xóa cache');
                    }

                    const data = await response.json();

                    loadingSpinner.style.display = 'none';

                    if (data.success) {
                        showAlert(successAlert, 'Đã xóa tất cả cache thành công');
                        // Cập nhật lại thống kê
                        fetchCacheStats();
                    } else {
                        throw new Error(data.error || 'Đã xảy ra lỗi');
                    }
                } catch (error) {
                    loadingSpinner.style.display = 'none';
                    console.error('Error clearing cache:', error);
                    showAlert(errorAlert, 'Không thể xóa cache: ' + error.message);
                }
            }

            // Xử lý sự kiện làm mới thống kê
            refreshStatsBtn.addEventListener('click', fetchCacheStats);

            // Xử lý sự kiện xóa cache
            clearCacheBtn.addEventListener('click', function () {
                if (confirm('Bạn có chắc chắn muốn xóa tất cả cache?')) {
                    clearAllCache();
                }
            });

            // Lấy thống kê khi trang được tải
            fetchCacheStats();
        });
    </script>
</body>

</html>